{% extends "base.html" %}

{% block title %}{{ article.title }} - {{ SITENAME }}{% endblock %}
{% block description %}{{ article.summary|striptags|truncate(160) }}{% endblock %}
{% block og_title %}{{ article.title }}{% endblock %}
{% block og_description %}{{ article.summary|striptags|truncate(160) }}{% endblock %}
{% block og_url %}{{ article.url }}{% endblock %}
{% block twitter_title %}{{ article.title }}{% endblock %}
{% block twitter_description %}{{ article.summary|striptags|truncate(160) }}{% endblock %}

{% block body_class %} class="post-page"{% endblock %}

{% block reading_progress %}
<div id="reading-progress" class="reading-progress"></div>
{% endblock %}

{% block content %}
<div class="back-link">
  <a href="{{ SITEURL }}/" aria-label="Back to Blog">&larr; Back</a>
</div>
<div class="page-header">
  <h1 class="page-title">{{ article.title }}</h1>
  <div class="page-date">{{ article.date.strftime('%Y-%m-%d') }}</div>
</div>
{% if article.image %}
<div class="article-hero-image">
  <img src="{{ SITEURL }}/{{ article.image }}" alt="{{ article.title }}" loading="lazy">
</div>
{% endif %}
<div class="page-content">
  {{ article.content }}
</div>
{% if article.prev_article or article.next_article %}
<div class="post-nav">
  {% if article.prev_article %}
    <a href="{{ SITEURL }}/{{ article.prev_article.url }}" aria-label="Previous Post">&larr; Prev</a>
  {% endif %}
  <span style="flex:1"></span>
  {% if article.next_article %}
    <a href="{{ SITEURL }}/{{ article.next_article.url }}" aria-label="Next Post">Next &rarr;</a>
  {% endif %}
</div>
{% endif %}

<!-- Fixed TOC Sidebar -->
<aside class="toc-sidebar" id="toc-sidebar">
  <div class="toc-container">
    <div class="toc-header">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 5h.01"></path><path d="M3 12h.01"></path><path d="M3 19h.01"></path><path d="M8 5h13"></path><path d="M8 12h13"></path><path d="M8 19h13"></path></svg>
      <span>On this page</span>
    </div>
    <nav class="toc-nav" aria-label="Table of contents">
      <ul id="toc-list"></ul>
    </nav>
  </div>
</aside>
{% endblock %}

{% block extra_js %}
<script>
  // Reading progress bar
  document.addEventListener('DOMContentLoaded', function() {
    var bar = document.getElementById('reading-progress');
    if (!bar) return;
    function updateBar() {
      var scrollTop = window.scrollY;
      var docHeight = document.body.scrollHeight - window.innerHeight;
      var percent = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
      bar.style.width = percent + '%';
    }
    window.addEventListener('scroll', updateBar);
    updateBar();
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Fix Obsidian-exported local image links
    var assetBase = "{{ SITEURL }}/images/";
    var externalPattern = /^(?:[a-z]+:)?\/\//i;
    var obsidianPatterns = ['pasted image', 'chatgpt image'];

    document.querySelectorAll('.page-content img').forEach(function(img) {
      var originalSrc = img.getAttribute('src');
      if (!originalSrc) return;
      if (externalPattern.test(originalSrc) || originalSrc.startsWith('/')) return;

      var decoded = decodeURIComponent(originalSrc);
      var lower = decoded.toLowerCase();
      var matchesObsidian = obsidianPatterns.some(function(pattern) {
        return lower.indexOf(pattern) !== -1;
      });
      if (!matchesObsidian) return;

      var filename = originalSrc.split('/').pop();
      if (!filename) return;

      img.setAttribute('src', assetBase + filename);
      if (!img.hasAttribute('loading')) {
        img.setAttribute('loading', 'lazy');
      }
    });
  });
</script>
<script>
  // Table of Contents Generator
  document.addEventListener('DOMContentLoaded', function() {
    var content = document.querySelector('.page-content');
    var tocList = document.getElementById('toc-list');
    if (!content || !tocList) return;

    var headings = content.querySelectorAll('h2, h3');
    if (headings.length < 2) {
      // Hide TOC if not enough headings
      var sidebar = document.querySelector('.toc-sidebar');
      if (sidebar) sidebar.style.display = 'none';
      return;
    }

    headings.forEach(function(heading, index) {
      // Add ID if missing
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }

      var li = document.createElement('li');
      li.className = 'toc-item toc-' + heading.tagName.toLowerCase();

      var a = document.createElement('a');
      a.href = '#' + heading.id;
      a.textContent = heading.textContent;
      a.className = 'toc-link';

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Highlight current section on scroll
    var tocLinks = tocList.querySelectorAll('.toc-link');
    var headingsList = Array.from(headings);

    function updateActiveLink() {
      var scrollPos = window.scrollY + 100;
      var current = null;

      headingsList.forEach(function(heading) {
        if (heading.offsetTop <= scrollPos) {
          current = heading;
        }
      });

      tocLinks.forEach(function(link) {
        link.classList.remove('active');
        if (current && link.getAttribute('href') === '#' + current.id) {
          link.classList.add('active');
        }
      });
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
  });
</script>
{% endblock %}
