{% extends "base.html" %}

{% block title %}{{ article.title }} - {{ SITENAME }}{% endblock %}
{% block description %}{{ article.summary|striptags|truncate(160) }}{% endblock %}
{% block og_title %}{{ article.title }}{% endblock %}
{% block og_description %}{{ article.summary|striptags|truncate(160) }}{% endblock %}
{% block og_url %}{{ article.url }}{% endblock %}
{% block twitter_title %}{{ article.title }}{% endblock %}
{% block twitter_description %}{{ article.summary|striptags|truncate(160) }}{% endblock %}

{% block body_class %} class="post-page"{% endblock %}

{% block reading_progress %}
<div id="reading-progress" class="reading-progress"></div>
{% endblock %}

{% block content %}
<div class="back-link">
  <a href="{{ SITEURL }}/" aria-label="Back to Blog">&larr; Back</a>
</div>
<div class="page-header">
  <h1 class="page-title">{{ article.title }}</h1>
  <div class="page-date">{{ article.date.strftime('%Y-%m-%d') }}</div>
</div>
{% if article.image %}
<div class="article-hero-image">
  <img src="{{ SITEURL }}/{{ article.image }}" alt="{{ article.title }}" loading="lazy">
</div>
{% endif %}
<div class="page-content">
  {{ article.content }}
</div>
{% if article.prev_article or article.next_article %}
<div class="post-nav">
  {% if article.prev_article %}
    <a href="{{ SITEURL }}/{{ article.prev_article.url }}" aria-label="Previous Post">&larr; Prev</a>
  {% endif %}
  <span style="flex:1"></span>
  {% if article.next_article %}
    <a href="{{ SITEURL }}/{{ article.next_article.url }}" aria-label="Next Post">Next &rarr;</a>
  {% endif %}
</div>
{% endif %}
{% endblock %}

{% block sidebar %}
<!-- Fixed TOC Sidebar - Outside container for fixed positioning -->
<aside class="toc-sidebar" id="toc-sidebar">
  <div class="toc-container">
    <div class="toc-header">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 5h.01"></path><path d="M3 12h.01"></path><path d="M3 19h.01"></path><path d="M8 5h13"></path><path d="M8 12h13"></path><path d="M8 19h13"></path></svg>
      <span>On this page</span>
    </div>
    <nav class="toc-nav" aria-label="Table of contents">
      <ul id="toc-list"></ul>
    </nav>
  </div>
</aside>
{% endblock %}

{% block extra_js %}
<script>
  // Reading progress bar
  document.addEventListener('DOMContentLoaded', function() {
    var bar = document.getElementById('reading-progress');
    if (!bar) return;
    function updateBar() {
      var scrollTop = window.scrollY;
      var docHeight = document.body.scrollHeight - window.innerHeight;
      var percent = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
      bar.style.width = percent + '%';
    }
    window.addEventListener('scroll', updateBar);
    updateBar();
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Fix Obsidian-exported local image links
    var assetBase = "{{ SITEURL }}/images/";
    var externalPattern = /^(?:[a-z]+:)?\/\//i;
    var obsidianPatterns = ['pasted image', 'chatgpt image'];

    document.querySelectorAll('.page-content img').forEach(function(img) {
      var originalSrc = img.getAttribute('src');
      if (!originalSrc) return;
      if (externalPattern.test(originalSrc) || originalSrc.startsWith('/')) return;

      var decoded = decodeURIComponent(originalSrc);
      var lower = decoded.toLowerCase();
      var matchesObsidian = obsidianPatterns.some(function(pattern) {
        return lower.indexOf(pattern) !== -1;
      });
      if (!matchesObsidian) return;

      var filename = originalSrc.split('/').pop();
      if (!filename) return;

      img.setAttribute('src', assetBase + filename);
      if (!img.hasAttribute('loading')) {
        img.setAttribute('loading', 'lazy');
      }
    });
  });
</script>
<script>
  // Table of Contents Generator
  document.addEventListener('DOMContentLoaded', function() {
    var content = document.querySelector('.page-content');
    var tocList = document.getElementById('toc-list');
    var tocSidebar = document.querySelector('.toc-sidebar');
    if (!content || !tocList || !tocSidebar) return;

    // Only use h2 headings for cleaner TOC
    var headings = content.querySelectorAll('h2');
    if (headings.length < 2) {
      tocSidebar.style.display = 'none';
      return;
    }

    // Skip boilerplate sections
    var skipSections = ['cite this post', 'acknowledgements', 'references'];
    var filteredHeadings = Array.from(headings).filter(function(h) {
      var text = h.textContent.replace(/\s*¶\s*$/, '').trim().toLowerCase();
      return skipSections.indexOf(text) === -1;
    });

    if (filteredHeadings.length < 2) {
      tocSidebar.style.display = 'none';
      return;
    }

    filteredHeadings.forEach(function(heading, index) {
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }

      var li = document.createElement('li');
      li.className = 'toc-item';

      var a = document.createElement('a');
      a.href = '#' + heading.id;
      var text = heading.textContent.replace(/\s*¶\s*$/, '').trim();
      text = text.replace(/^\d+\.\s*/, '');
      a.textContent = text;
      a.className = 'toc-link';

      // Smooth scroll on click
      a.addEventListener('click', function(e) {
        e.preventDefault();
        var target = document.getElementById(heading.id);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          history.replaceState(null, '', '#' + heading.id);
        }
      });

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Highlight current section on scroll + fade TOC in/out
    var tocLinks = tocList.querySelectorAll('.toc-link');
    var firstHeadingTop = filteredHeadings[0] ? filteredHeadings[0].offsetTop : 300;

    function onScroll() {
      var scrollPos = window.scrollY + 120;

      // Fade in TOC after scrolling past the page header
      if (window.scrollY > firstHeadingTop - 200) {
        tocSidebar.classList.add('visible');
      } else {
        tocSidebar.classList.remove('visible');
      }

      // Update active link
      var current = null;
      filteredHeadings.forEach(function(heading) {
        if (heading.offsetTop <= scrollPos) {
          current = heading;
        }
      });

      tocLinks.forEach(function(link) {
        link.classList.remove('active');
        if (current && link.getAttribute('href') === '#' + current.id) {
          link.classList.add('active');
        }
      });
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    onScroll();
  });
</script>
{% endblock %}
